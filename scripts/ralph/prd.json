{
  "version": "2.4",
  "project": "Intelligent Image Generation with Nano Banana API",
  "branchName": "ralph/intelligent-image-generation",
  "description": "Add intelligent image generation feature using Google's Nano Banana API (Gemini) that analyzes LinkedIn posts, classifies content, recommends image styles, and generates LinkedIn-optimized images",
  "createdAt": "2026-01-14T10:00:00Z",
  "techStack": {
    "backend": "Python/FastAPI with Pydantic",
    "database": "In-memory with encrypted session storage",
    "frontend": "React 19 with TypeScript + Vite",
    "testing": "Pytest (backend) + Vitest (frontend)"
  },
  "functionalRequirements": [
    {
      "id": "FR-001",
      "title": "Content Analysis Service",
      "description": "Backend service to analyze generated LinkedIn post content and extract key themes, technologies, and sentiment for image generation",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN a LinkedIn post text WHEN analyze endpoint is called THEN return extracted themes, technologies, and sentiment",
        "GIVEN an empty post WHEN analyze is called THEN return appropriate error response"
      ]
    },
    {
      "id": "FR-002",
      "title": "Content Type Classification",
      "description": "Classify posts into LinkedIn content types (Tutorial, Announcement, Tips, Story, Technical, Career) based on content analysis",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN analyzed post content WHEN classification is performed THEN return one of six defined content types",
        "GIVEN content with multiple signals WHEN classified THEN return the most dominant type with confidence score"
      ]
    },
    {
      "id": "FR-003",
      "title": "Image Style Recommendation",
      "description": "Recommend appropriate image styles based on content classification to optimize engagement",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN a content classification WHEN recommendation is requested THEN return ordered list of suitable image styles",
        "GIVEN Tutorial content type WHEN recommended THEN return infographic or minimalist styles first"
      ]
    },
    {
      "id": "FR-004",
      "title": "Gemini Authentication",
      "description": "Implement API key connection for Google Gemini (Nano Banana) following existing Claude/OpenAI authentication pattern",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN a valid Gemini API key WHEN connect endpoint is called THEN key is encrypted and stored in session",
        "GIVEN an invalid Gemini API key WHEN connect is attempted THEN return validation error with message",
        "GIVEN a connected session WHEN disconnect is called THEN key is securely removed"
      ]
    },
    {
      "id": "FR-005",
      "title": "Image Generation Service",
      "description": "Generate images using Nano Banana API based on content analysis and style recommendations",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN valid post content and style WHEN generate image is called THEN return base64 encoded image",
        "GIVEN API error WHEN generation fails THEN return user-friendly error with retry option"
      ]
    },
    {
      "id": "FR-006",
      "title": "LinkedIn Dimension Optimization",
      "description": "Generate images in LinkedIn-optimized dimensions with user-selectable format options",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN dimension selection WHEN image is generated THEN output matches exact LinkedIn specs (1200x627, 1080x1080, or 1200x1200)",
        "GIVEN no dimension specified WHEN generated THEN default to 1200x627 (link post size)"
      ]
    },
    {
      "id": "FR-007",
      "title": "Frontend Image Generation UI",
      "description": "Add image generation panel to the post generation workflow with style selection and dimension options",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN generated post WHEN image panel is shown THEN display recommended styles and dimension options",
        "GIVEN image generation in progress WHEN waiting THEN show loading state with progress indicator"
      ]
    },
    {
      "id": "FR-008",
      "title": "Image Preview Component",
      "description": "Display generated image with download and copy functionality",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN generated image WHEN preview is displayed THEN show image at actual dimensions with download button",
        "GIVEN preview image WHEN download is clicked THEN save image in selected format (PNG/JPEG)"
      ]
    },
    {
      "id": "FR-009",
      "title": "Image Prompt Customization",
      "description": "Allow users to view and modify the auto-generated image prompt before generation",
      "priority": "should",
      "acceptanceCriteria": [
        "GIVEN auto-generated prompt WHEN user edits THEN updated prompt is used for generation",
        "GIVEN modified prompt WHEN regenerate is clicked THEN new image reflects changes"
      ]
    },
    {
      "id": "FR-010",
      "title": "Image Style Override",
      "description": "Allow users to select different image styles than the recommended one",
      "priority": "should",
      "acceptanceCriteria": [
        "GIVEN style recommendations WHEN user selects different style THEN generation uses selected style",
        "GIVEN style selection WHEN changed THEN prompt is automatically updated to reflect new style"
      ]
    }
  ],
  "nonFunctionalRequirements": [
    {
      "id": "NFR-001",
      "title": "Response Time",
      "priority": "must",
      "acceptanceCriteria": [
        "Image generation API must respond within 30 seconds",
        "Content analysis must complete within 2 seconds"
      ]
    },
    {
      "id": "NFR-002",
      "title": "API Key Security",
      "priority": "must",
      "acceptanceCriteria": [
        "Gemini API keys must be encrypted at rest using existing encryption service",
        "Keys must never be logged or exposed in responses",
        "Session cleanup must remove keys after expiry"
      ]
    },
    {
      "id": "NFR-003",
      "title": "Rate Limiting",
      "priority": "must",
      "acceptanceCriteria": [
        "Image generation endpoint limited to 20 requests per minute per session",
        "Rate limit responses include Retry-After header"
      ]
    },
    {
      "id": "NFR-004",
      "title": "Error Handling",
      "priority": "must",
      "acceptanceCriteria": [
        "All API errors return user-friendly messages",
        "Frontend displays retry button with countdown for rate limits"
      ]
    },
    {
      "id": "NFR-005",
      "title": "TypeScript Strict Mode",
      "priority": "must",
      "acceptanceCriteria": [
        "All frontend code must pass npm run typecheck",
        "No TypeScript any types without explicit justification"
      ]
    },
    {
      "id": "NFR-006",
      "title": "Test Coverage",
      "priority": "should",
      "acceptanceCriteria": [
        "Content analyzer service has unit tests",
        "Gemini client has unit tests with mocked API responses"
      ]
    },
    {
      "id": "NFR-007",
      "title": "Accessibility",
      "priority": "should",
      "acceptanceCriteria": [
        "Image preview includes alt text describing content",
        "All interactive elements are keyboard accessible"
      ]
    },
    {
      "id": "NFR-SEC-001",
      "title": "Secure Session Cookies",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN session cookie WHEN created THEN HttpOnly flag is set",
        "GIVEN session cookie WHEN created THEN Secure flag is set",
        "GIVEN session cookie WHEN created THEN SameSite=Strict attribute is set",
        "GIVEN session WHEN inactive for 24 hours THEN session automatically expires"
      ]
    },
    {
      "id": "NFR-SEC-002",
      "title": "Audit Logging",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN API key connect/disconnect WHEN action completes THEN audit log entry created",
        "GIVEN image generation request WHEN processed THEN audit log entry created with request metadata",
        "GIVEN audit log WHEN written THEN no sensitive data (API keys, prompts) included"
      ]
    },
    {
      "id": "NFR-SEC-003",
      "title": "Error Message Security",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN API error WHEN response generated THEN no stack traces exposed",
        "GIVEN error response WHEN containing internal paths THEN paths are sanitized",
        "GIVEN error with correlation ID WHEN returned THEN ID can be used for debugging without exposing internals"
      ]
    },
    {
      "id": "NFR-SEC-004",
      "title": "Input Size Limits",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN post content WHEN exceeds 10KB THEN return 413 Payload Too Large",
        "GIVEN image prompt WHEN exceeds 2KB THEN return 413 Payload Too Large",
        "GIVEN any endpoint WHEN receiving oversized payload THEN request rejected before processing"
      ]
    },
    {
      "id": "NFR-SEC-005",
      "title": "CORS Configuration",
      "priority": "must",
      "acceptanceCriteria": [
        "GIVEN CORS policy WHEN configured THEN only frontend origin is allowed",
        "GIVEN request from unauthorized origin WHEN received THEN return 403 Forbidden",
        "GIVEN credentials WHEN sent cross-origin THEN only allowed to configured origin"
      ]
    },
    {
      "id": "NFR-SEC-006",
      "title": "Dependency Security",
      "priority": "should",
      "acceptanceCriteria": [
        "GIVEN Python dependencies WHEN audited THEN no critical CVEs present",
        "GIVEN Node.js dependencies WHEN audited THEN no critical CVEs present",
        "GIVEN critical vulnerability WHEN discovered THEN patched within 7 days"
      ]
    }
  ],
  "securityAnalysis": {
    "version": "1.0",
    "analysisDate": "2026-01-14",
    "applicableRegulations": [
      {
        "regulation": "PDPA",
        "applicable": true,
        "justification": "Application handles user API keys linked to personal Google accounts, session identifiers, and user-generated content"
      },
      {
        "regulation": "OWASP",
        "applicable": true,
        "justification": "Web application handling user authentication, API integrations, and user-generated content"
      },
      {
        "regulation": "Cross-Border Transfer",
        "applicable": true,
        "justification": "LinkedIn post content sent to Google Gemini API servers located outside Singapore"
      },
      {
        "regulation": "MAS TRM",
        "applicable": false,
        "justification": "Not a financial institution"
      },
      {
        "regulation": "IM8",
        "applicable": false,
        "justification": "Not a government/public sector project"
      }
    ],
    "dataClassification": [
      {
        "dataType": "Gemini API Key",
        "classification": "SECRET",
        "encryption": "TLS in transit + AES-256 at rest",
        "accessLevel": "Session-only, user who owns the key",
        "retention": "Session lifetime (auto-cleanup on disconnect/expiry)"
      },
      {
        "dataType": "LinkedIn Post Content",
        "classification": "USER CONTENT",
        "encryption": "TLS in transit",
        "accessLevel": "Processing-only, not persisted",
        "retention": "Not retained (processed and discarded)"
      },
      {
        "dataType": "Generated Image Prompts",
        "classification": "USER CONTENT",
        "encryption": "TLS in transit",
        "accessLevel": "Processing-only",
        "retention": "Not retained"
      },
      {
        "dataType": "Generated Images (base64)",
        "classification": "USER CONTENT",
        "encryption": "TLS in transit",
        "accessLevel": "User session only",
        "retention": "Not persisted (returned to client only)"
      },
      {
        "dataType": "Session Identifier",
        "classification": "SENSITIVE",
        "encryption": "TLS in transit",
        "accessLevel": "Server-side only",
        "retention": "Session lifetime (24h max)"
      },
      {
        "dataType": "Error Logs",
        "classification": "INTERNAL",
        "encryption": "None required",
        "accessLevel": "DevOps/Admin",
        "retention": "30 days recommended"
      }
    ],
    "threatModel": [
      {
        "threat": "Spoofing - Session Impersonation",
        "asset": "User sessions, API keys",
        "likelihood": "M",
        "impact": "H",
        "mitigation": "Session token validation, secure session cookies (HttpOnly, Secure, SameSite), session fixation prevention",
        "priority": "P0"
      },
      {
        "threat": "Spoofing - Stolen API Key Usage",
        "asset": "Gemini API quota, user billing",
        "likelihood": "M",
        "impact": "H",
        "mitigation": "API key encryption, no key exposure in logs/responses, masked display in UI",
        "priority": "P0"
      },
      {
        "threat": "Tampering - Prompt Injection",
        "asset": "Image generation service, brand reputation",
        "likelihood": "M",
        "impact": "M",
        "mitigation": "Input sanitization, prompt templates with bounded parameters, content moderation keywords block",
        "priority": "P1"
      },
      {
        "threat": "Tampering - Rate Limit Bypass",
        "asset": "API resources, service availability",
        "likelihood": "L",
        "impact": "M",
        "mitigation": "Server-side rate limiting per session, request signing, session validation",
        "priority": "P1"
      },
      {
        "threat": "Repudiation - Content Generation Denial",
        "asset": "Audit trail, legal compliance",
        "likelihood": "L",
        "impact": "M",
        "mitigation": "Audit logging of generation requests (without sensitive content), session-user correlation",
        "priority": "P2"
      },
      {
        "threat": "Information Disclosure - API Key Leakage",
        "asset": "Gemini API keys",
        "likelihood": "M",
        "impact": "H",
        "mitigation": "Never log API keys, mask in all responses (show last 4 chars only), redact from error messages",
        "priority": "P0"
      },
      {
        "threat": "Information Disclosure - Content Leakage",
        "asset": "User content, privacy",
        "likelihood": "L",
        "impact": "H",
        "mitigation": "Session isolation, no server-side image caching, proper session scoping",
        "priority": "P1"
      },
      {
        "threat": "Denial of Service - Rate Limit Exhaustion",
        "asset": "Service availability",
        "likelihood": "M",
        "impact": "M",
        "mitigation": "Per-session rate limiting (20/min), global rate limiting, request queuing",
        "priority": "P1"
      },
      {
        "threat": "Elevation of Privilege - Session Hijacking",
        "asset": "User API keys, session data",
        "likelihood": "L",
        "impact": "H",
        "mitigation": "Secure session management, session binding, short session lifetime",
        "priority": "P0"
      },
      {
        "threat": "Elevation of Privilege - Unauthenticated Access",
        "asset": "Protected endpoints",
        "likelihood": "M",
        "impact": "H",
        "mitigation": "Middleware authentication on all /generate and /auth endpoints, 401 for missing auth",
        "priority": "P0"
      }
    ],
    "securityRequirements": [
      {
        "id": "SEC-001",
        "requirement": "Encrypt Gemini API keys at rest using AES-256",
        "regulation": "PDPA, OWASP A02",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN a Gemini API key is stored WHEN encryption_service.encrypt() is called THEN key is encrypted using AES-256 AND original plaintext is never persisted"
      },
      {
        "id": "SEC-002",
        "requirement": "Never log or expose API keys in responses",
        "regulation": "PDPA, OWASP A02",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN any API response or log entry WHEN API key is involved THEN only masked version (last 4 chars) is visible AND full key is never in logs/responses"
      },
      {
        "id": "SEC-003",
        "requirement": "Validate and sanitize all user inputs",
        "regulation": "OWASP A03",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN user input (post content, prompt, style) WHEN received by API THEN Pydantic validates against schema AND special characters are escaped AND max lengths enforced"
      },
      {
        "id": "SEC-004",
        "requirement": "Implement session-based authentication for protected endpoints",
        "regulation": "OWASP A01, A07",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN request to /api/generate/* or /api/auth/* WHEN session is invalid or missing THEN return 401 Unauthorized"
      },
      {
        "id": "SEC-005",
        "requirement": "Apply rate limiting to image generation endpoint",
        "regulation": "OWASP A04",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN image generation requests WHEN more than 20 requests per minute from same session THEN return 429 with Retry-After header"
      },
      {
        "id": "SEC-006",
        "requirement": "Implement secure session management",
        "regulation": "OWASP A07",
        "priority": "P0",
        "acceptanceCriteria": "GIVEN session cookie WHEN set THEN include HttpOnly, Secure, SameSite=Strict flags AND session expires within 24 hours"
      },
      {
        "id": "SEC-007",
        "requirement": "No sensitive data in error responses",
        "regulation": "OWASP A02, A09",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN any API error WHEN response generated THEN response contains user-friendly message AND no stack traces/internal paths/API keys exposed"
      },
      {
        "id": "SEC-008",
        "requirement": "Implement audit logging for security events",
        "regulation": "PDPA, OWASP A09",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN API key connect/disconnect or image generation WHEN action completes THEN log event with timestamp, session ID, action type (no sensitive data)"
      },
      {
        "id": "SEC-009",
        "requirement": "Secure cross-origin requests",
        "regulation": "OWASP A05",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN CORS configuration WHEN request from unauthorized origin THEN reject with 403 AND only allow configured frontend origin"
      },
      {
        "id": "SEC-010",
        "requirement": "Content size limits on all endpoints",
        "regulation": "OWASP A04",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN request body WHEN size exceeds limit (10KB for post, 2KB for prompt) THEN return 413 Payload Too Large"
      },
      {
        "id": "SEC-011",
        "requirement": "Prompt injection prevention",
        "regulation": "OWASP A03",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN user-customized prompt WHEN sent to Gemini API THEN wrap in safe prompt template AND filter known injection patterns"
      },
      {
        "id": "SEC-012",
        "requirement": "Session cleanup on disconnect",
        "regulation": "PDPA",
        "priority": "P1",
        "acceptanceCriteria": "GIVEN user disconnects or session expires WHEN cleanup triggered THEN encrypted API key is securely deleted AND session data cleared"
      }
    ],
    "owaspChecklist": {
      "A01_BrokenAccessControl": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "Image generation endpoints must validate session; ensure user can only access their own session data"
      },
      "A02_CryptographicFailures": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "API keys must be encrypted with AES-256; TLS 1.3 required for all traffic; no hardcoded secrets"
      },
      "A03_Injection": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "User prompts could contain injection attempts; require Pydantic validation and prompt sanitization"
      },
      "A04_InsecureDesign": {
        "vulnerable": false,
        "status": "Addressed in PRD",
        "notes": "Rate limiting designed in; session-based auth pattern follows existing secure implementation"
      },
      "A05_SecurityMisconfiguration": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "CORS must be properly configured; error pages must not leak info; default credentials must not exist"
      },
      "A06_VulnerableComponents": {
        "vulnerable": true,
        "status": "Requires review",
        "notes": "Dependencies (httpx, cryptography, Pydantic) should be audited; use Dependabot/Snyk for monitoring"
      },
      "A07_AuthFailures": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "Session management must be secure; API key validation required before use"
      },
      "A08_DataIntegrityFailures": {
        "vulnerable": false,
        "status": "N/A",
        "notes": "No software updates or CI/CD pipelines in scope; image generation is stateless"
      },
      "A09_LoggingFailures": {
        "vulnerable": true,
        "status": "Requires mitigation",
        "notes": "Must implement audit logging; must ensure no sensitive data in logs"
      },
      "A10_SSRF": {
        "vulnerable": false,
        "status": "N/A",
        "notes": "Application makes outbound calls to Gemini API only; no user-controlled URLs in backend requests"
      }
    },
    "crossBorderDataTransfer": {
      "required": true,
      "destination": "Google Gemini API servers (US)",
      "dataTransferred": [
        "LinkedIn post content",
        "Image generation prompts"
      ],
      "recommendation": "Add user disclosure: 'By connecting your Gemini API key, you acknowledge that your LinkedIn post content will be sent to Google servers for image generation. This data may be processed outside of Singapore.'"
    },
    "summary": {
      "criticalItems": 6,
      "highPriorityItems": 6,
      "complianceStatus": "PDPA applicable - requires consent disclosure, encryption, and audit logging",
      "owaspCoverage": "8 of 10 risks require mitigation"
    }
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Content Analyzer Service",
      "description": "As a developer, I want a backend service that analyzes LinkedIn post content so that themes, technologies, and sentiment can be extracted for image generation",
      "acceptanceCriteria": [
        "GIVEN a LinkedIn post text WHEN ContentAnalyzer.analyze() is called THEN return ContentAnalysis object with themes, technologies, and sentiment",
        "GIVEN post mentioning Python and FastAPI WHEN analyzed THEN technologies array includes 'Python' and 'FastAPI'",
        "GIVEN empty or None post WHEN analyzed THEN raise ValueError with descriptive message",
        "pytest backend/tests/test_content_analyzer.py passes"
      ],
      "priority": 1,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "backend/src/analyzers/content_analyzer.py",
        "backend/src/models/image_schemas.py",
        "backend/tests/test_content_analyzer.py"
      ],
      "dependencies": [],
      "testStrategy": "Unit tests with sample LinkedIn posts covering different content types",
      "securityCategory": "validation",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "",
      "completedAt": "2026-01-14T16:59:40.427483"
    },
    {
      "id": "US-002",
      "title": "Implement Content Classification",
      "description": "As a developer, I want the system to classify posts into LinkedIn content types so that appropriate image styles can be recommended",
      "acceptanceCriteria": [
        "GIVEN ContentAnalysis WHEN classify() is called THEN return ContentType enum value",
        "GIVEN tutorial-style post WHEN classified THEN return ContentType.TUTORIAL with confidence >= 0.7",
        "GIVEN ambiguous content WHEN classified THEN return most likely type with lower confidence score",
        "Classification supports all 6 types: TUTORIAL, ANNOUNCEMENT, TIPS, STORY, TECHNICAL, CAREER",
        "pytest backend/tests/test_content_classifier.py passes"
      ],
      "priority": 1,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "backend/src/analyzers/content_classifier.py",
        "backend/src/models/image_schemas.py",
        "backend/tests/test_content_classifier.py"
      ],
      "dependencies": [
        "US-001"
      ],
      "testStrategy": "Unit tests with sample posts for each content type",
      "securityCategory": "none",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "",
      "completedAt": "2026-01-14T09:06:13.439925Z"
    },
    {
      "id": "US-003",
      "title": "Create Image Style Recommender",
      "description": "As a developer, I want a service that recommends image styles based on content type so that generated images match the post's purpose",
      "acceptanceCriteria": [
        "GIVEN ContentType.TUTORIAL WHEN recommend() is called THEN return ['infographic', 'minimalist', 'conceptual'] in order",
        "GIVEN any content type WHEN recommended THEN return at least 3 style options",
        "GIVEN content type and tech stack WHEN recommended THEN styles consider technology themes",
        "pytest backend/tests/test_style_recommender.py passes"
      ],
      "priority": 1,
      "complexity": 2,
      "estimatedMinutes": 25,
      "filesAffected": [
        "backend/src/generators/image_generator/style_recommender.py",
        "backend/src/models/image_schemas.py",
        "backend/tests/test_style_recommender.py"
      ],
      "dependencies": [
        "US-002"
      ],
      "testStrategy": "Unit tests mapping content types to expected style recommendations",
      "securityCategory": "none",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "",
      "completedAt": "2026-01-14T17:30:00Z"
    },
    {
      "id": "US-004",
      "title": "Implement Gemini Auth Backend",
      "description": "As a user, I want to connect my Gemini API key securely so that I can use image generation features",
      "acceptanceCriteria": [
        "GIVEN valid Gemini API key WHEN POST /api/auth/gemini/connect is called THEN return success with masked key",
        "GIVEN invalid Gemini API key WHEN connect attempted THEN return 400 with validation error message",
        "GIVEN connected session WHEN GET /api/auth/gemini/status is called THEN return connected=true with masked key",
        "GIVEN connected session WHEN POST /api/auth/gemini/disconnect is called THEN key is removed and status shows disconnected",
        "API key is encrypted using existing encryption_service.py",
        "pytest backend/tests/test_gemini_routes.py passes"
      ],
      "priority": 2,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "backend/src/api/gemini_routes.py",
        "backend/src/models/gemini_schemas.py",
        "backend/src/services/key_storage_service.py",
        "backend/src/api/main.py",
        "backend/tests/test_gemini_routes.py"
      ],
      "dependencies": [],
      "testStrategy": "Integration tests for auth endpoints with mocked Gemini validation",
      "securityCategory": "authentication",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "",
      "completedAt": "2026-01-14T18:00:00Z"
    },
    {
      "id": "US-005",
      "title": "Create Nano Banana Client",
      "description": "As a developer, I want a Gemini/Nano Banana API client so that the system can generate images",
      "acceptanceCriteria": [
        "GIVEN valid API key and prompt WHEN generate_image() is called THEN return base64 encoded image data",
        "GIVEN dimension parameter WHEN generating THEN request specifies exact dimensions (1200x627, 1080x1080, or 1200x1200)",
        "GIVEN API error WHEN generation fails THEN raise GeminiAPIError with user-friendly message",
        "GIVEN rate limit response WHEN received THEN raise RateLimitError with retry_after value",
        "Client uses httpx for async HTTP requests",
        "pytest backend/tests/test_gemini_client.py passes"
      ],
      "priority": 2,
      "complexity": 4,
      "estimatedMinutes": 40,
      "filesAffected": [
        "backend/src/services/gemini_client.py",
        "backend/src/models/gemini_schemas.py",
        "backend/tests/test_gemini_client.py"
      ],
      "dependencies": [
        "US-004"
      ],
      "testStrategy": "Unit tests with mocked httpx responses for success, error, and rate limit scenarios",
      "securityCategory": "encryption",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "",
      "completedAt": "2026-01-14T18:30:00Z"
    },
    {
      "id": "US-006",
      "title": "Implement Image Generation Endpoint",
      "description": "As a user, I want an API endpoint that generates images from my post content so that I can get contextual images",
      "acceptanceCriteria": [
        "GIVEN valid post content and connected Gemini WHEN POST /api/generate/image is called THEN return generated image with metadata",
        "GIVEN no Gemini connection WHEN generate called THEN return 401 with message to connect API key",
        "GIVEN post content WHEN generating THEN auto-analyze, classify, and recommend style before generation",
        "GIVEN optional style override WHEN provided THEN use specified style instead of recommendation",
        "Response includes: image_base64, content_type, recommended_style, dimensions, prompt_used",
        "Rate limiting applied (20/min)",
        "pytest backend/tests/test_image_generation.py passes"
      ],
      "priority": 3,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "backend/src/api/image_routes.py",
        "backend/src/models/image_schemas.py",
        "backend/src/api/main.py",
        "backend/tests/test_image_generation.py"
      ],
      "dependencies": [
        "US-003",
        "US-005"
      ],
      "testStrategy": "Integration tests for endpoint with mocked Gemini client",
      "securityCategory": "authorization",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-007",
      "title": "Create Gemini Auth UI",
      "description": "As a user, I want a UI to connect my Gemini API key so that I can access image generation features",
      "acceptanceCriteria": [
        "GIVEN GeminiAuthForm component WHEN rendered THEN show API key input and connect button",
        "GIVEN valid API key WHEN submitted THEN call connect API and show success state with masked key",
        "GIVEN invalid API key WHEN submitted THEN show error message with retry option",
        "GIVEN connected state WHEN displayed THEN show masked key and disconnect button",
        "Component follows existing ClaudeAuthForm patterns",
        "npm run typecheck passes",
        "Component renders without errors"
      ],
      "priority": 3,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "frontend/src/components/gemini-auth/GeminiAuthForm.tsx",
        "frontend/src/components/gemini-auth/index.ts",
        "frontend/src/lib/api.ts",
        "frontend/src/store/appStore.ts"
      ],
      "dependencies": [
        "US-004"
      ],
      "testStrategy": "Component tests for render states and user interactions",
      "securityCategory": "authentication",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-008",
      "title": "Create Image Generation Panel",
      "description": "As a user, I want an image generation panel that shows style recommendations and dimension options so that I can generate appropriate images for my posts",
      "acceptanceCriteria": [
        "GIVEN ImageGenerationPanel component WHEN post is generated THEN show recommended styles and dimension selector",
        "GIVEN style options WHEN user selects different style THEN update UI and store selection",
        "GIVEN dimension selector WHEN user selects THEN show preview of dimensions (1200x627, 1080x1080, 1200x1200)",
        "GIVEN generate button WHEN clicked THEN show loading state and call image generation API",
        "GIVEN generation in progress WHEN waiting THEN show spinner with cancel option",
        "npm run typecheck passes",
        "Component renders without errors"
      ],
      "priority": 4,
      "complexity": 4,
      "estimatedMinutes": 40,
      "filesAffected": [
        "frontend/src/components/posts/ImageGenerationPanel.tsx",
        "frontend/src/components/posts/index.ts",
        "frontend/src/lib/api.ts",
        "frontend/src/store/appStore.ts"
      ],
      "dependencies": [
        "US-006",
        "US-007"
      ],
      "testStrategy": "Component tests for UI states, style selection, and API integration",
      "securityCategory": "none",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-009",
      "title": "Create Image Preview Component",
      "description": "As a user, I want to preview generated images with download options so that I can use them with my LinkedIn posts",
      "acceptanceCriteria": [
        "GIVEN ImagePreview component WHEN image is generated THEN display image at actual dimensions",
        "GIVEN preview WHEN download button clicked THEN download image as PNG file",
        "GIVEN preview WHEN copy button clicked THEN copy image to clipboard",
        "GIVEN preview WHEN regenerate clicked THEN trigger new generation with same settings",
        "Component includes alt text for accessibility",
        "npm run typecheck passes",
        "Component renders without errors"
      ],
      "priority": 4,
      "complexity": 2,
      "estimatedMinutes": 25,
      "filesAffected": [
        "frontend/src/components/posts/ImagePreview.tsx",
        "frontend/src/components/posts/index.ts",
        "frontend/src/hooks/useImageDownload.ts"
      ],
      "dependencies": [
        "US-008"
      ],
      "testStrategy": "Component tests for display, download, and copy functionality",
      "securityCategory": "none",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-010",
      "title": "Integrate Image Gen into Workflow",
      "description": "As a user, I want image generation integrated into the post generation workflow so that I can generate images alongside my posts",
      "acceptanceCriteria": [
        "GIVEN AIPostGenerator WHEN post is generated THEN ImageGenerationPanel appears below post content",
        "GIVEN Gemini not connected WHEN panel shown THEN display connect prompt with link to auth",
        "GIVEN provider section WHEN rendered THEN show Gemini as third provider option alongside Claude and OpenAI",
        "GIVEN all providers connected WHEN displayed THEN show unified content with image generation option",
        "npm run typecheck passes",
        "Full workflow renders without errors"
      ],
      "priority": 5,
      "complexity": 3,
      "estimatedMinutes": 30,
      "filesAffected": [
        "frontend/src/components/posts/AIPostGenerator.tsx",
        "frontend/src/components/provider/ProviderSelector.tsx",
        "frontend/src/App.tsx",
        "frontend/src/store/appStore.ts"
      ],
      "dependencies": [
        "US-008",
        "US-009"
      ],
      "testStrategy": "Integration tests for complete workflow from post generation to image generation",
      "securityCategory": "none",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-011",
      "title": "Add Image Customization Options",
      "description": "As a user, I want to customize the image prompt before generation so that I can fine-tune the generated image",
      "acceptanceCriteria": [
        "GIVEN ImageGenerationPanel WHEN advanced options toggled THEN show editable prompt textarea",
        "GIVEN auto-generated prompt WHEN displayed THEN show in editable textarea with edit indicator",
        "GIVEN user edits prompt WHEN regenerate clicked THEN use modified prompt for generation",
        "GIVEN reset button WHEN clicked THEN restore original auto-generated prompt",
        "npm run typecheck passes",
        "Component renders without errors"
      ],
      "priority": 5,
      "complexity": 2,
      "estimatedMinutes": 25,
      "filesAffected": [
        "frontend/src/components/posts/ImageGenerationPanel.tsx",
        "frontend/src/components/posts/PromptEditor.tsx"
      ],
      "dependencies": [
        "US-008"
      ],
      "testStrategy": "Component tests for prompt editing and reset functionality",
      "securityCategory": "validation",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "",
      "completedAt": null
    },
    {
      "id": "US-SEC-001",
      "title": "Implement Secure API Key Storage",
      "description": "As a user, I want my Gemini API key encrypted at rest so that it cannot be stolen if the server is compromised",
      "acceptanceCriteria": [
        "GIVEN a Gemini API key WHEN stored in session THEN key is encrypted using AES-256 via encryption_service.py",
        "GIVEN any log output WHEN API key is involved THEN only masked version (****xxxx) appears",
        "GIVEN API response WHEN key is included THEN only last 4 characters are visible",
        "Security scan passes with 0 critical findings for credential exposure",
        "pytest backend/tests/test_key_encryption.py passes"
      ],
      "priority": 1,
      "complexity": 2,
      "estimatedMinutes": 20,
      "filesAffected": [
        "backend/src/services/encryption_service.py",
        "backend/src/services/key_storage_service.py",
        "backend/src/api/gemini_routes.py",
        "backend/tests/test_key_encryption.py"
      ],
      "dependencies": [],
      "testStrategy": "Unit tests for encryption/decryption, integration tests for key masking in responses",
      "securityCategory": "encryption",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "Critical P0 security requirement - PDPA compliance",
      "completedAt": "2026-01-14T09:27:25.150265+00:00"
    },
    {
      "id": "US-SEC-002",
      "title": "Implement Input Validation for Image Generation",
      "description": "As a system, I want all image generation inputs validated so that injection attacks are prevented",
      "acceptanceCriteria": [
        "GIVEN post content input WHEN exceeds 10KB THEN return 413 error",
        "GIVEN custom prompt WHEN exceeds 2KB THEN return 413 error",
        "GIVEN dimension parameter WHEN not in [1200x627, 1080x1080, 1200x1200] THEN return 400 error",
        "GIVEN malicious prompt patterns WHEN detected THEN sanitize or reject with 400 error",
        "All inputs validated through Pydantic schemas",
        "pytest backend/tests/test_input_validation.py passes"
      ],
      "priority": 1,
      "complexity": 2,
      "estimatedMinutes": 25,
      "filesAffected": [
        "backend/src/models/image_schemas.py",
        "backend/src/validators/prompt_validator.py",
        "backend/src/api/image_routes.py",
        "backend/tests/test_input_validation.py"
      ],
      "dependencies": [],
      "testStrategy": "Unit tests for validation edge cases, injection pattern testing",
      "securityCategory": "validation",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "Critical P0 security requirement - OWASP A03 compliance",
      "completedAt": "2026-01-14T17:45:00Z"
    },
    {
      "id": "US-SEC-003",
      "title": "Implement Secure Session Management",
      "description": "As a user, I want my session securely managed so that my credentials cannot be hijacked",
      "acceptanceCriteria": [
        "GIVEN session cookie WHEN created THEN has HttpOnly, Secure, SameSite=Strict flags",
        "GIVEN session WHEN older than 24 hours THEN automatically expired and API key deleted",
        "GIVEN protected endpoint WHEN no valid session THEN return 401 Unauthorized",
        "GIVEN session disconnect WHEN triggered THEN encrypted API key securely deleted",
        "pytest backend/tests/test_session_security.py passes"
      ],
      "priority": 1,
      "complexity": 2,
      "estimatedMinutes": 20,
      "filesAffected": [
        "backend/src/middleware/session_middleware.py",
        "backend/src/services/session_service.py",
        "backend/src/api/gemini_routes.py",
        "backend/tests/test_session_security.py"
      ],
      "dependencies": [
        "US-SEC-001"
      ],
      "testStrategy": "Integration tests for session lifecycle and security attributes",
      "securityCategory": "authentication",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "Critical P0 security requirement - OWASP A07 compliance",
      "completedAt": "2026-01-14T17:50:00Z"
    },
    {
      "id": "US-SEC-004",
      "title": "Implement Security Audit Logging",
      "description": "As a compliance officer, I want security events logged so that incidents can be investigated",
      "acceptanceCriteria": [
        "GIVEN API key connect/disconnect WHEN action completes THEN audit log created with timestamp and session ID",
        "GIVEN image generation WHEN completed THEN audit log created with request metadata",
        "GIVEN any audit log WHEN written THEN contains no sensitive data (API keys, prompt content)",
        "GIVEN audit logs WHEN queried THEN support filtering by date and session",
        "pytest backend/tests/test_audit_logging.py passes"
      ],
      "priority": 2,
      "complexity": 2,
      "estimatedMinutes": 25,
      "filesAffected": [
        "backend/src/services/audit_logger.py",
        "backend/src/api/gemini_routes.py",
        "backend/src/api/image_routes.py",
        "backend/tests/test_audit_logging.py"
      ],
      "dependencies": [
        "US-004",
        "US-006"
      ],
      "testStrategy": "Unit tests for log formatting, integration tests for event capture",
      "securityCategory": "logging",
      "state": "pending",
      "passes": false,
      "retryCount": 0,
      "notes": "P1 security requirement - PDPA and OWASP A09 compliance",
      "completedAt": null
    },
    {
      "id": "US-SEC-005",
      "title": "Implement Error Handling Without Data Leakage",
      "description": "As a security system, I want error responses sanitized so that internal details are not exposed",
      "acceptanceCriteria": [
        "GIVEN any API error WHEN response generated THEN no stack traces in response body",
        "GIVEN Gemini API error WHEN occurring THEN no API key in error message",
        "GIVEN internal error WHEN occurring THEN return generic 500 message with correlation ID",
        "GIVEN validation error WHEN occurring THEN return helpful message without internal paths",
        "pytest backend/tests/test_error_handling.py passes"
      ],
      "priority": 2,
      "complexity": 1,
      "estimatedMinutes": 15,
      "filesAffected": [
        "backend/src/middleware/error_handler.py",
        "backend/src/api/image_routes.py",
        "backend/src/api/gemini_routes.py",
        "backend/tests/test_error_handling.py"
      ],
      "dependencies": [],
      "testStrategy": "Unit tests for error response formatting, fuzz testing for leakage",
      "securityCategory": "validation",
      "state": "passed",
      "passes": true,
      "retryCount": 0,
      "notes": "P1 security requirement - OWASP A02 and A09 compliance",
      "completedAt": "2026-01-14T19:15:00Z"
    }
  ],
  "globalConstraints": [
    "All Python code must follow PEP 8 style guidelines",
    "All frontend code must pass TypeScript strict mode",
    "No console.log in production code (use proper logging)",
    "All user inputs must be validated with Pydantic (backend) or Zod (frontend)",
    "No secrets in code (use environment variables)",
    "Follow existing code patterns for authentication and error handling",
    "API keys must never be logged or exposed in responses",
    "All new endpoints must include rate limiting"
  ],
  "inScope": [
    "Content analysis and classification for LinkedIn posts",
    "Image style recommendation based on content type",
    "Gemini/Nano Banana API integration (authentication, validation, generation)",
    "LinkedIn-optimized image dimensions (1200x627, 1080x1080, 1200x1200)",
    "Frontend UI for image generation workflow",
    "Image preview with download and copy functionality",
    "User customization of image prompts",
    "Style override capability",
    "Error handling and retry mechanisms",
    "Rate limiting for image generation endpoint"
  ],
  "outOfScope": [
    "Image editing capabilities (crop, filter, adjust)",
    "Multiple image generation in single request",
    "Image storage/history persistence",
    "Direct LinkedIn posting integration",
    "Video generation",
    "Animation/GIF generation",
    "Custom model training",
    "Batch processing of multiple posts",
    "Image watermarking"
  ],
  "openQuestions": [
    {
      "question": "Will users need to provide their own Gemini API key?",
      "assumption": "Yes, consistent with Claude/OpenAI pattern"
    },
    {
      "question": "Should we support multiple image formats?",
      "assumption": "Default to PNG, offer JPEG as download option"
    },
    {
      "question": "How many regeneration attempts should be allowed per post?",
      "assumption": "Unlimited within rate limit"
    },
    {
      "question": "What happens if Gemini API is unavailable?",
      "assumption": "Display error with retry option, no fallback"
    },
    {
      "question": "Should generated images be cached server-side?",
      "assumption": "No caching initially (out of scope for MVP)"
    }
  ],
  "validationScore": 91.67,
  "validationNotes": [
    "V-001: NFR acceptance criteria not in GIVEN-WHEN-THEN format (Low)",
    "V-002: Stories US-008, US-009, US-010 form tight dependency chain (Low)",
    "V-003: Nano Banana/Gemini API response structure not documented (Low)",
    "V-004: Parallelization opportunity for US-001 and US-004 (Info)",
    "V-005: Inconsistent naming - Nano Banana vs Gemini (Low)",
    "V-006: Barrel file creation not explicit in acceptance criteria (Info)"
  ]
}